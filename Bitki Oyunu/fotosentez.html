<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kloroplast Fabrikasƒ± - Fotosentez Maceralarƒ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: manipulation;
        }

        body {
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
            min-height: 100dvh; 
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            color: white;
            overflow: hidden; 
        }

        .game-container {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(12px);
            border-radius: 22px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.7);
            width: 100%;
            max-width: 95vw;
            /* Ana Fix: Kalan alanƒ± kapla ve dikey flex yapƒ±sƒ±nƒ± koru */
            height: calc(100dvh - 16px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid #2ecc71;
        }

        .header {
            background: linear-gradient(135deg, #27ae60, #2ecc71, #16a085);
            padding: 16px 14px;
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0; 
        }

        .header h1 {
            font-size: clamp(1.5rem, 4.5vw, 2.2rem);
            margin-bottom: 5px;
            color: white;
            text-shadow: 0 0 15px rgba(46, 204, 113, 0.8);
            font-weight: 800;
        }

        .header .subtitle {
            font-size: clamp(0.85rem, 2.8vw, 1.1em);
            opacity: 0.9;
        }

        .score-board {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 6px;
            flex-wrap: wrap;
        }

        .score-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 10px;
            backdrop-filter: blur(7px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex: 1;
            min-width: 60px;
            max-width: 100px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        .score-label {
            font-size: clamp(0.6rem, 2.2vw, 0.8em);
            opacity: 0.85;
            margin-bottom: 3px;
        }

        .score-value {
            font-size: clamp(1rem, 3.2vw, 1.5em);
            font-weight: bold;
            color: #fff;
        }

        .game-area {
            flex-grow: 1; 
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .screen {
            text-align: center;
            color: #d0f0c0;
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow-y: auto; 
            padding: 16px;
        }

        h2 {
            color: #2ecc71;
            font-size: clamp(1.5rem, 4.8vw, 2em);
            margin-bottom: 14px;
            text-shadow: 0 0 12px rgba(46, 204, 113, 0.6);
        }

        p {
            font-size: clamp(0.9rem, 3vw, 1em);
            line-height: 1.6;
            margin-bottom: 16px;
            color: #a8e6cf;
            padding: 0 6px;
        }

        .btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 26px;
            font-size: clamp(0.95rem, 3.2vw, 1.1em);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
            margin: 8px 4px;
            font-weight: 600;
            min-width: 150px;
            flex-shrink: 0;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.7);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.5);
        }

        .btn-secondary:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.7);
        }

        .game-canvas {
            background: linear-gradient(to bottom, #0a3d62 0%, #1e5128 50%, #2d6a4f 100%);
            border-radius: 18px;
            padding: 14px;
            position: relative;
            flex-grow: 1; 
            min-height: 250px; 
            border: 2px solid #27ae60;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
            margin-top: 10px;
            width: 100%;
        }

        .sun-source {
            position: absolute;
            top: 14px;
            left: 50%;
            transform: translateX(-50%);
            width: 150px;
            height: 45px;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.8);
            font-size: clamp(0.65rem, 2.3vw, 0.85rem);
            animation: glow 2s infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(243, 156, 18, 0.8); }
            50% { box-shadow: 0 0 35px rgba(243, 156, 18, 1); }
        }

        .chloroplast-zone {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 130px;
            height: 130px;
            background: radial-gradient(circle, #27ae60, #1e8449, #145a32);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: clamp(2rem, 6vw, 2.8em);
            box-shadow: 0 0 30px rgba(39, 174, 96, 0.8), inset 0 0 20px rgba(0, 0, 0, 0.5);
            border: 3px solid #2ecc71;
            transition: all 0.3s;
            cursor: pointer;
            z-index: 10;
        }

        .chloroplast-zone:hover {
            transform: translateX(-50%) scale(1.08);
            box-shadow: 0 0 45px rgba(39, 174, 96, 1);
        }

        .chloroplast-zone.drag-over {
            transform: translateX(-50%) scale(1.12);
            box-shadow: 0 0 60px rgba(46, 204, 113, 1), inset 0 0 30px rgba(255, 255, 255, 0.3);
            background: radial-gradient(circle, #2ecc71, #27ae60, #16a085);
        }

        .chloroplast-text {
            font-size: 0.32em;
            margin-top: 6px;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .element {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.8rem, 5.5vw, 2.3em);
            cursor: grab;
            user-select: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            touch-action: none;
            z-index: 5;
        }

        .water { background: linear-gradient(135deg, #3498db, #2980b9); box-shadow: 0 5px 15px rgba(52,152,219,0.6); }
        .co2 { background: linear-gradient(135deg, #95a5a6, #7f8c8d); box-shadow: 0 5px 15px rgba(149,165,166,0.6); }
        .sun { background: linear-gradient(135deg, #f39c12, #e67e22); box-shadow: 0 5px 15px rgba(243,156,18,0.8); }
        .toxic { background: linear-gradient(135deg, #8e44ad, #6c3483); box-shadow: 0 5px 15px rgba(142,68,173,0.6); }
        .pollution { background: linear-gradient(135deg, #2c3e50, #34495e); box-shadow: 0 5px 15px rgba(44,62,80,0.6); }

        .o2-bubble {
            position: absolute;
            width: 32px;
            height: 32px;
            background: radial-gradient(circle, #e8f8f5, #a3e4d7);
            border-radius: 50%;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: bubbleRise 2s ease-out forwards;
            pointer-events: none;
            box-shadow: 0 2px 7px rgba(163, 228, 215, 0.6);
            z-index: 20;
        }

        @keyframes bubbleRise {
            0% { opacity: 1; transform: translateY(0) scale(0.5); }
            100% { opacity: 0; transform: translateY(-160px) scale(1.4); }
        }

        .glucose-production {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.92);
            padding: 30px;
            border-radius: 24px;
            box-shadow: 0 0 70px rgba(46, 204, 113, 1);
            font-size: clamp(1.6rem, 5vw, 2.2em);
            font-weight: bold;
            color: #2ecc71;
            z-index: 1000;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid #2ecc71;
            animation: glucosePop 1s ease-out forwards;
            max-width: 90vw;
            word-break: break-word;
        }

        @keyframes glucosePop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(8deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0); opacity: 1; }
        }

        .message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: rgba(0, 0, 0, 0.85);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            font-size: clamp(1.1rem, 3.8vw, 1.5em);
            font-weight: bold;
            color: #fff;
            z-index: 999;
            text-align: center;
            backdrop-filter: blur(10px);
            animation: message-pop 0.6s ease-out forwards;
        }

        .message.success { color: #2ecc71; border: 2px solid #2ecc71; }
        .message.error { color: #e74c3c; border: 2px solid #e74c3c; }
        .message.warning { color: #f39c12; border: 2px solid #f39c12; }

        @keyframes message-pop {
            0% { transform: translate(-50%, -50%) scale(0.3); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 22px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 11px;
            overflow: hidden;
            margin: 14px 0;
            border: 2px solid rgba(46, 204, 113, 0.5);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #27ae60, #16a085);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .hidden {
            display: none;
        }

        .info-box {
            background: rgba(46, 204, 113, 0.1);
            border-left: 4px solid #2ecc71;
            padding: 16px;
            margin: 14px 0;
            border-radius: 10px;
            backdrop-filter: blur(8px);
            text-align: left;
            flex-shrink: 0; 
        }

        .info-box h3 {
            color: #2ecc71;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .info-box ul {
            padding-left: 20px;
            line-height: 1.8;
        }

        .combo-display {
            position: absolute;
            top: 80px;
            right: 12px;
            background: rgba(46, 204, 113, 0.9);
            padding: 10px 18px;
            border-radius: 16px;
            font-weight: bold;
            color: white;
            font-size: clamp(1.1rem, 3.5vw, 1.4em);
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.8);
            animation: comboPulse 0.5s infinite;
            z-index: 50;
        }

        @keyframes comboPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.06); }
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }

        .shake {
            animation: shakeScreen 0.5s;
        }

        @keyframes shakeScreen {
            0%, 100% { transform: translate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, -5px); }
            20%, 40%, 60%, 80% { transform: translate(5px, 5px); }
        }

        .end-screen h2 {
            color: #2ecc71;
            font-size: clamp(1.8rem, 5.5vw, 2.4em);
            margin-bottom: 14px;
        }

        .final-score {
            font-size: clamp(2.4rem, 7vw, 3.2em);
            color: #f39c12;
            margin: 16px 0;
            text-shadow: 0 0 15px rgba(243, 156, 18, 0.8);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1> Kloroplast Fabrikasƒ± </h1>
            <div class="subtitle">Fotosentez Maceralarƒ± - Yakala ve √úret!</div>
            <div class="score-board">
                <div class="score-item">
                    <div class="score-label">‚è±Ô∏è S√ºre</div>
                    <div class="score-value" id="timeValue">90</div>
                </div>
                <div class="score-item">
                    <div class="score-label">üíß Su (6)</div>
                    <div class="score-value" id="waterCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">üå´Ô∏è CO‚ÇÇ (6)</div>
                    <div class="score-value" id="co2Count">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">‚òÄÔ∏è G√ºne≈ü (6)</div>
                    <div class="score-value" id="sunCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">üç¨ Glikoz</div>
                    <div class="score-value" id="glucoseCount">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">üèÜ Puan</div>
                    <div class="score-value" id="scoreValue">0</div>
                </div>
            </div>
        </div>

        <div class="game-area">
            <div id="startScreen" class="screen">
                <h2> Fotosentez Fabrikasƒ±na Ho≈ü Geldin!</h2>
                <p>
                    <strong>G√∂revin:</strong> Hareketli maddeleri yakalayƒ±p kloroplasta s√ºr√ºkle!<br>
                    <strong>1 Glikoz = 6 Su + 6 CO‚ÇÇ + 6 G√ºne≈ü I≈üƒ±ƒüƒ±</strong>
                </p>
                <div class="info-box">
                    <h3>üéØ Nasƒ±l Oynanƒ±r?</h3>
                    <ul>
                        <li>üíß Su, üå´Ô∏è CO‚ÇÇ ve ‚òÄÔ∏è G√ºne≈ü ƒ±≈üƒ±ƒüƒ±nƒ± topla.</li>
                        <li>Hepsinden <strong>6'≈üar tane</strong> biriktirerek Glikoz √ºret.</li>
                        <li>‚ò†Ô∏è Toksik ve ‚ö´ Kirlilik puanƒ±nƒ± d√º≈ü√ºr√ºr.</li>
                        <li>Oyun ilerledik√ße, toplanan maddelerin hƒ±zƒ± artar.</li>
                    </ul>
                </div>
                <button class="btn" onclick="startGame()">Fotosenteze Ba≈üla! üöÄ</button>
                <button class="btn btn-secondary" onclick="showInfo()">Fotosentez Bilgisi üìö</button>
            </div>

            <div id="infoScreen" class="screen hidden">
                <h2> Fotosentez Nedir?</h2>
                <div class="info-box">
                    <h3>Ger√ßek Kimyasal Denklem</h3>
                    <p style="text-align: center; font-size: 1.3em; margin: 12px 0; font-family: monospace;">
                        6CO‚ÇÇ + 6H‚ÇÇO + I≈üƒ±k ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ
                    </p>
                    <ul>
                        <li>üíß <strong>6 su molek√ºl√º</strong> k√∂klerden alƒ±nƒ±r</li>
                        <li>üå´Ô∏è <strong>6 karbondioksit molek√ºl√º</strong> yaprak g√∂zeneklerinden</li>
                        <li>‚òÄÔ∏è <strong>I≈üƒ±k enerjisi</strong> klorofil tarafƒ±ndan emilir</li>
                        <li>üç¨ <strong>1 glikoz</strong> + <strong>6 oksijen</strong> √ºretilir</li>
                    </ul>
                </div>
                <div class="info-box">
                    <h3>üî¨ Kloroplast</h3>
                    <ul>
                        <li>üü¢ Bitki h√ºcrelerinin enerji fabrikasƒ±</li>
                        <li>üß¨ Klorofil ye≈üil rengi verir ve ƒ±≈üƒ±ƒüƒ± emer</li>
                        <li>üåç D√ºnya'daki t√ºm oksijenin kaynaƒüƒ±!</li>
                    </ul>
                </div>
                <button class="btn" onclick="showScreen('startScreen')">Geri D√∂n</button>
            </div>

            <div id="gameScreen" class="screen hidden" style="padding: 0;">
                <div class="progress-bar">
                    <div class="progress-fill" id="timerBar">
                        <span id="timerText">90s</span>
                    </div>
                </div>
                <div class="game-canvas" id="gameCanvas">
                    <div class="sun-source">‚òÄÔ∏è G√ºne≈ü I≈üƒ±ƒüƒ± ‚òÄÔ∏è</div>
                    <div class="chloroplast-zone" id="chloroplastZone">
                        <div class="chloroplast-text">KLOROPLAST</div>
                    </div>
                </div>
            </div>

            <div id="endScreen" class="screen hidden">
                <h2>üéâ Fotosentez Tamamlandƒ±! üéâ</h2>
                <p style="font-size: 1.1em;">
                    Harika bir h√ºcre y√∂neticisisin! 
                </p>
                <div class="final-score">
                    <span id="finalGlucose">0</span> üç¨
                </div>
                <p style="font-size: 1em;">
                    Glikoz Molek√ºl√º √úrettin!
                </p>
                <div style="margin: 18px 0;">
                    <p style="font-size: 1em;">Toplam Puan: <strong id="finalScore" style="color: #f39c12; font-size: 1.3em;">0</strong></p>
                </div>
                <div class="info-box">
                    <p><strong>üåü ƒ∞lgin√ß Bilgi:</strong> D√ºnya'daki bitkiler her yƒ±l yakla≈üƒ±k 100-115 milyar ton oksijen √ºretir!</p>
                </div>
                <button class="btn" onclick="restartGame()">Tekrar Oyna! üîÑ</button>
                <button class="btn btn-secondary" onclick="showInfo()">Daha Fazla √ñƒüren üìö</button>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            time: 90,
            water: 0,
            co2: 0,
            sun: 0,
            glucose: 0,
            score: 0,
            combo: 0,
            elements: [],
            dragged: null,
            timer: null,
            spawnInterval: 1500,
            lastSpeedUpdate: 90,
            baseSpeed: 1.2,
            gameActive: false,
            audioContext: null
        };

        const REQUIRED = 6;

        const elementTypes = [
            { type: 'water', emoji: 'üíß', class: 'water', points: 5, weight: 4 },
            { type: 'co2', emoji: 'üå´Ô∏è', class: 'co2', points: 5, weight: 2 },
            { type: 'sun', emoji: '‚òÄÔ∏è', class: 'sun', points: 5, weight: 2 },
            { type: 'toxic', emoji: '‚ò†Ô∏è', class: 'toxic', points: -5, harmful: true, weight: 1 },
            { type: 'pollution', emoji: '‚ö´', class: 'pollution', points: -8, harmful: true, weight: 1 }
        ];

        function getWeightedRandomElement() {
            const total = elementTypes.reduce((sum, item) => sum + item.weight, 0);
            let rand = Math.random() * total;
            for (const item of elementTypes) {
                if (rand < item.weight) return item;
                rand -= item.weight;
            }
            return elementTypes[0];
        }

        function initAudio() {
            if (!gameState.audioContext) {
                gameState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!gameState.audioContext) return;
            const ctx = gameState.audioContext;
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            switch (type) {
                case 'collect':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(523.25, ctx.currentTime);
                    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(ctx.currentTime + 0.2);
                    break;
                case 'wrong':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, ctx.currentTime);
                    gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(ctx.currentTime + 0.3);
                    break;
                case 'glucose':
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            const o = ctx.createOscillator();
                            const g = ctx.createGain();
                            o.connect(g);
                            g.connect(ctx.destination);
                            o.type = 'sine';
                            o.frequency.setValueAtTime(440 + i * 80, ctx.currentTime);
                            g.gain.setValueAtTime(0.2, ctx.currentTime);
                            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                            o.start();
                            o.stop(ctx.currentTime + 0.3);
                        }, i * 100);
                    }
                    break;
                case 'oxygen':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, ctx.currentTime);
                    gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                    oscillator.start();
                    oscillator.stop(ctx.currentTime + 0.5);
                    break;
            }
        }

        function updateUI() {
            document.getElementById('timeValue').textContent = gameState.time;
            document.getElementById('waterCount').textContent = gameState.water;
            document.getElementById('co2Count').textContent = gameState.co2;
            document.getElementById('sunCount').textContent = gameState.sun;
            document.getElementById('glucoseCount').textContent = gameState.glucose;
            document.getElementById('scoreValue').textContent = gameState.score;
        }

        function showScreen(id) {
            ['startScreen', 'infoScreen', 'gameScreen', 'endScreen'].forEach(s => {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function showInfo() { showScreen('infoScreen'); }

        let animationFrameId = null;
        function startPhysics() {
            if (animationFrameId) return;
            gameState.gameActive = true;
            animate();
        }

        function stopPhysics() {
            gameState.gameActive = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
        }

        function animate() {
            if (!gameState.gameActive) return;
            moveElements();
            animationFrameId = requestAnimationFrame(animate);
        }

        function moveElements() {
            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            const maxX = rect.width - 55;
            const maxY = rect.height - 55;

            for (let obj of gameState.elements) {
                if (obj.element === gameState.dragged) continue; 
                if (!obj.element || !obj.element.parentNode) continue;

                const speedMultiplier = 1 + (90 - gameState.time) * 0.008;
                const speed = obj.speed * speedMultiplier;

                let x = parseFloat(obj.element.style.left) || 0;
                let y = parseFloat(obj.element.style.top) || 0;

                x += obj.vx * speed;
                y += obj.vy * speed;

                if (x <= 0 || x >= maxX) {
                    obj.vx *= -1;
                    x = Math.max(0, Math.min(maxX, x));
                }
                if (y <= 70 || y >= maxY) {
                    obj.vy *= -1;
                    y = Math.max(70, Math.min(maxY, y));
                }

                obj.element.style.left = x + 'px';
                obj.element.style.top = y + 'px';
            }
        }
        function setupTouchDrag(el, typeInfo) {
            let touchId = null;
            let startX, startY, elemX, elemY;
            let canvasRect;
            
            const onStart = (clientX, clientY) => {
                const gameObj = gameState.elements.find(e => e.element === el);
                if (!gameObj) return false;

                gameState.dragged = el; 
                canvasRect = document.getElementById('gameCanvas').getBoundingClientRect();
                
                startX = clientX;
                startY = clientY;
                elemX = parseFloat(el.style.left) || 0;
                elemY = parseFloat(el.style.top) || 0;
                
                el.style.opacity = '0.6';
                el.style.zIndex = '100'; 

                const currentObj = gameState.elements.find(o => o.element === el);
                if (currentObj) {
                    currentObj.vx = 0;
                    currentObj.vy = 0;
                }
                return true;
            };

            const onMove = (clientX, clientY) => {
                if (gameState.dragged !== el || !canvasRect) return;
                
                // Mouse/Touch pozisyonunu Canvas'ƒ±n i√ßine g√∂re hesapla
                const newX = clientX - canvasRect.left - 30; 
                const newY = clientY - canvasRect.top - 30;
                
                // Elementin canvas sƒ±nƒ±rlarƒ± i√ßinde kalmasƒ±nƒ± saƒüla
                const maxX = canvasRect.width - 60;
                const maxY = canvasRect.height - 60;
                
                el.style.left = Math.max(0, Math.min(maxX, newX)) + 'px';
                el.style.top = Math.max(0, Math.min(maxY, newY)) + 'px';
            };

            const onEnd = (clientX, clientY) => {
                if (gameState.dragged !== el) return;
                el.style.opacity = '1';
                el.style.zIndex = '5';
                handleDrop(clientX, clientY, el, typeInfo);
                gameState.dragged = null;
            };

            // --- TOUCH Handlers ---
            const onTouchStart = (e) => {
                const touch = e.changedTouches[0];
                touchId = touch.identifier;
                if (onStart(touch.clientX, touch.clientY)) {
                    e.preventDefault();
                }
            };

            const onTouchMove = (e) => {
                const touch = Array.from(e.changedTouches).find(t => t.identifier === touchId);
                if (!touch) return;
                onMove(touch.clientX, touch.clientY);
                e.preventDefault();
            };

            const onTouchEnd = (e) => {
                const touch = Array.from(e.changedTouches).find(t => t.identifier === touchId);
                if (!touch) return;
                touchId = null;
                onEnd(touch.clientX, touch.clientY);
                e.preventDefault();
            };

            el.addEventListener('touchstart', onTouchStart, { passive: false });
            el.addEventListener('touchmove', onTouchMove, { passive: false });
            el.addEventListener('touchend', onTouchEnd, { passive: false });

            // --- MOUSE Handlers ---
            el.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return;
                if (onStart(e.clientX, e.clientY)) {
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                }
            });

            const onMouseMove = (e) => onMove(e.clientX, e.clientY);
            const onMouseUp = (e) => {
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                onEnd(e.clientX, e.clientY);
            };
        }

        function handleDrop(clientX, clientY, el, typeInfo) {
            const zone = document.getElementById('chloroplastZone');
            const zoneRect = zone.getBoundingClientRect();
            
            if (clientX >= zoneRect.left && clientX <= zoneRect.right && 
                clientY >= zoneRect.top && clientY <= zoneRect.bottom) 
            {
                const idx = gameState.elements.findIndex(e => e.element === el);
                if (idx !== -1) gameState.elements.splice(idx, 1);

                if (typeInfo.harmful) {
                    handleHarmful(el, typeInfo);
                } else {
                    handleCorrect(el, typeInfo.type, typeInfo);
                }
                el.remove();
            } else {
                const elementData = gameState.elements.find(e => e.element === el);
                if (elementData) {
                    elementData.vx = (Math.random() > 0.5 ? 1 : -1) * gameState.baseSpeed;
                    elementData.vy = (Math.random() > 0.5 ? 1 : -1) * gameState.baseSpeed;
                }
                el.style.zIndex = '5';
            }
        }

        function spawnElement() {
            const type = getWeightedRandomElement();
            const el = document.createElement('div');
            const id = 'el_' + Date.now() + Math.random();

            el.id = id;
            el.className = `element ${type.class}`;
            el.textContent = type.emoji;
            el.dataset.type = type.type;

            const canvas = document.getElementById('gameCanvas');
            const rect = canvas.getBoundingClientRect();
            const maxX = rect.width - 60;
            const maxY = rect.height - 60;
            const x = 20 + Math.random() * (maxX - 40);
            const y = 80 + Math.random() * (maxY - 100); 
            el.style.left = x + 'px';
            el.style.top = y + 'px';

            const angle = Math.random() * Math.PI * 2;
            const baseSpeed = gameState.baseSpeed;
            const vx = Math.cos(angle) * baseSpeed;
            const vy = Math.sin(angle) * baseSpeed;

            setupTouchDrag(el, type);

            canvas.appendChild(el);

            gameState.elements.push({
                id,
                type,
                element: el,
                vx,
                vy,
                speed: baseSpeed
            });

            if (type.harmful) {
                setTimeout(() => {
                    const idx = gameState.elements.findIndex(e => e.id === id);
                    if (idx !== -1) {
                        if (el.parentNode) el.remove();
                        gameState.elements.splice(idx, 1);
                    }
                }, 6000);
            }
        }

        function setupDropZone() {}
        
        function handleCorrect(el, type, info) {
            playSound('collect');
            if (type === 'water') gameState.water++;
            else if (type === 'co2') gameState.co2++;
            else if (type === 'sun') gameState.sun++;

            gameState.score += info.points;
            gameState.combo++;
            createParticles(el, '#2ecc71');
            showMessage(`‚úÖ ${info.emoji} +${info.points}`, 'success');
            checkGlucoseProduction();
            updateUI();
            if (gameState.combo >= 5) showCombo();
        }

        function handleHarmful(el, info) {
            playSound('wrong');
            gameState.score = Math.max(0, gameState.score + info.points);
            gameState.combo = 0;
            createParticles(el, '#e74c3c');
            showMessage(`‚ùå ${info.emoji} ${info.points}`, 'error');
            document.body.classList.add('shake');
            setTimeout(() => document.body.classList.remove('shake'), 500);
            updateUI();
        }

        function checkGlucoseProduction() {
            if (gameState.water >= REQUIRED && gameState.co2 >= REQUIRED && gameState.sun >= REQUIRED) {
                gameState.water -= REQUIRED;
                gameState.co2 -= REQUIRED;
                gameState.sun -= REQUIRED;
                gameState.glucose++;
                gameState.score += 100;
                playSound('glucose');
                produceGlucose();
                produceOxygen();
                updateUI();
            }
        }

        function produceGlucose() {
            const div = document.createElement('div');
            div.className = 'glucose-production';
            div.innerHTML = `üç¨ GLIKOZ √úRETƒ∞LDƒ∞!<br><div style="font-size:0.5em;margin-top:8px;">6H‚ÇÇO + 6CO‚ÇÇ + I≈üƒ±k ‚Üí C‚ÇÜH‚ÇÅ‚ÇÇO‚ÇÜ + 6O‚ÇÇ</div><div style="font-size:0.4em;color:#f39c12;margin-top:6px;">+100 PUAN!</div>`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 2000);
        }

        function produceOxygen() {
            const zone = document.getElementById('chloroplastZone');
            const zRect = zone.getBoundingClientRect();
            const cRect = document.getElementById('gameCanvas').getBoundingClientRect();

            for (let i = 0; i < 6; i++) {
                setTimeout(() => {
                    const bubble = document.createElement('div');
                    bubble.className = 'o2-bubble';
                    bubble.textContent = 'üí®';
                    bubble.style.left = (zRect.left - cRect.left + zRect.width / 2 - 14) + 'px';
                    bubble.style.top = (zRect.top - cRect.top + 25) + 'px';
                    document.getElementById('gameCanvas').appendChild(bubble);
                    playSound('oxygen');
                    setTimeout(() => bubble.remove(), 2000);
                }, i * 200);
            }
        }

        function showCombo() {
            const existing = document.getElementById('comboDisplay');
            if (existing) existing.remove();
            const combo = document.createElement('div');
            combo.id = 'comboDisplay';
            combo.className = 'combo-display';
            combo.textContent = `üî• COMBO x${gameState.combo}!`;
            document.getElementById('gameCanvas').appendChild(combo);
            setTimeout(() => { if (combo.parentNode) combo.remove(); }, 2000);
        }

        function createParticles(el, color) {
            const rect = el.getBoundingClientRect();
            const canvas = document.getElementById('gameCanvas');
            const cRect = canvas.getBoundingClientRect();
            for (let i = 0; i < 12; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.backgroundColor = color;
                p.style.width = '6px';
                p.style.height = '6px';
                p.style.left = (rect.left - cRect.left + 25) + 'px';
                p.style.top = (rect.top - cRect.top + 25) + 'px';
                canvas.appendChild(p);
                const angle = Math.random() * Math.PI * 2;
                const speed = 2 + Math.random() * 4;
                let x = parseFloat(p.style.left), y = parseFloat(p.style.top), opacity = 1;
                const anim = () => {
                    opacity -= 0.025;
                    x += Math.cos(angle) * speed;
                    y += Math.sin(angle) * speed;
                    p.style.opacity = opacity;
                    p.style.left = x + 'px';
                    p.style.top = y + 'px';
                    if (opacity > 0) requestAnimationFrame(anim);
                    else p.remove();
                };
                requestAnimationFrame(anim);
            }
        }

        function showMessage(text, type) {
            const msg = document.createElement('div');
            msg.className = `message ${type}`;
            msg.textContent = text;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 1500);
        }

        let spawnTimerId = null;

        function updateTimer() {
            gameState.time--;
            
            // Hƒ±z Artƒ±≈üƒ± Kontrol√º (Orijinal hali korundu)
            if (gameState.time < gameState.lastSpeedUpdate && gameState.time % 10 === 0 && gameState.time > 0) {
                gameState.spawnInterval = Math.max(500, gameState.spawnInterval * 0.85);
                clearInterval(spawnTimerId);
                spawnTimerId = setInterval(spawnElement, gameState.spawnInterval);
                gameState.lastSpeedUpdate = gameState.time;
            }

            const perc = (gameState.time / 90) * 100;
            document.getElementById('timerBar').style.width = perc + '%';
            document.getElementById('timerText').textContent = gameState.time + 's';

            if (gameState.time <= 0) {
                endGame();
            }
        }

        function startGame() {
            gameState = {
                time: 90,
                water: 0,
                co2: 0,
                sun: 0,
                glucose: 0,
                score: 0,
                combo: 0,
                elements: [],
                dragged: null,
                spawnInterval: 1500,
                lastSpeedUpdate: 90,
                baseSpeed: 1.2,
                gameActive: true,
                audioContext: gameState.audioContext
            };

            updateUI();
            showScreen('gameScreen');
            document.getElementById('gameCanvas').innerHTML = `
                <div class="sun-source">‚òÄÔ∏è G√ºne≈ü I≈üƒ±ƒüƒ± ‚òÄÔ∏è</div>
                <div class="chloroplast-zone" id="chloroplastZone">
                    <div class="chloroplast-text">KLOROPLAST</div>
                </div>
            `;

            initAudio();
            setupDropZone();
            startPhysics();
            spawnElement();
            spawnTimerId = setInterval(spawnElement, gameState.spawnInterval);
            gameState.timer = setInterval(updateTimer, 1000);
        }

        function endGame() {
            clearInterval(gameState.timer);
            clearInterval(spawnTimerId);
            stopPhysics();
            document.getElementById('finalGlucose').textContent = gameState.glucose;
            document.getElementById('finalScore').textContent = gameState.score;
            showScreen('endScreen');
        }

        function restartGame() {
            startGame();
        }

        updateUI();
    </script>
</body>
</html>